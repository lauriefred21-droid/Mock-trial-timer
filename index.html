<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Mock Trial Timer</title>
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(130,87,229,0.35), transparent 60%),
        radial-gradient(900px 700px at 110% 10%, rgba(44,203,161,0.25), transparent 55%),
        radial-gradient(900px 700px at 50% 120%, rgba(255,181,72,0.18), transparent 55%),
        #070814;
      color:#f3f4f6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: manipulation;
    }

    header{
      padding:14px 16px calc(12px + env(safe-area-inset-top));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,0.08);
      position:sticky;
      top:0;
      background: rgba(7,8,20,0.65);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index:10;
      gap: 12px;
    }
    header h1{ font-size:16px; margin:0; font-weight:950; letter-spacing:.2px; }
    header .subtitle{ font-size:12px; opacity:.7; margin-top:2px; }

    .top-controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:850;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space: nowrap;
    }
    .chip input{ transform: scale(1.12); }

    .rolebox{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 10px 12px;
      display: grid;
      gap: 8px;
      min-width: 260px;
    }
    .rolebox .title{
      font-size: 12px;
      opacity: .8;
      font-weight: 850;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
    .rolebox .row{
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .roleopt{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 13px;
      font-weight: 900;
      opacity: .95;
      user-select: none;
    }
    .roleopt input { transform: scale(1.12); }

    .wrap{
      padding:16px 16px calc(20px + env(safe-area-inset-bottom));
      max-width:900px;
      margin:0 auto;
    }

    .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:860px){
      .grid{ grid-template-columns:1fr 1fr; }
      .span-2{ grid-column:1 / span 2; }
    }

    .card{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(600px 240px at 20% 0%, rgba(255,255,255,0.12), transparent 60%);
      pointer-events:none;
    }

    .label{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      position:relative;
    }
    .name{
      font-size:13px;
      opacity:.92;
      font-weight:950;
      letter-spacing:.25px;
      text-transform:uppercase;
    }
    .hint{ font-size:12px; opacity:.7; font-weight:750; }

    .time{
      font-variant-numeric: tabular-nums;
      letter-spacing:.6px;
      user-select:none;
      margin:8px 0 12px;
      position:relative;
      font-weight:980;
    }
    .time.big{ font-size:72px; line-height:1.0; }
    .time.med{ font-size:54px; line-height:1.03; }
    @media (max-width:420px){
      .time.big{ font-size:58px; }
      .time.med{ font-size:44px; }
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:10px;
      position:relative;
    }

    button{
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color:#f3f4f6;
      padding:12px 14px;
      border-radius:14px;
      font-size:14px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      min-height:48px;
    }
    button:active{ transform: scale(0.99); }

    button.primary{
      background: rgba(255,255,255,0.92);
      color:#0b1020;
      border-color: rgba(255,255,255,0.92);
    }
    button.pause{
      background: rgba(255, 70, 70, 0.18);
      border-color: rgba(255, 70, 70, 0.35);
      font-weight:980;
    }
    button.reset{
      padding:10px 12px;
      min-height:44px;
      font-size:12px;
      font-weight:850;
      opacity:.92;
    }

    .dock{
      margin-top:12px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(7,8,20,0.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      display:grid;
      gap:10px;
      position:relative;
    }
    .dock-top{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
    }
    .dock-title{ font-weight:980; letter-spacing:.3px; }
    .dock-sub{ font-size:12px; opacity:.75; font-weight:750; }

    .dock-buttons{ display:grid; grid-template-columns:1fr; gap:10px; }
    button.objection{
      background: rgba(255, 70, 70, 0.92);
      border-color: rgba(255, 70, 70, 0.92);
      color:#0b1020;
      font-weight:990;
      letter-spacing:.4px;
      min-height:56px;
      font-size:16px;
    }
    button.resume{
      background: rgba(44,203,161,0.72);
      border-color: rgba(44,203,161,0.72);
      color:#071018;
      font-weight:990;
      min-height:56px;
      font-size:16px;
    }

    button.resetall{
      background: rgba(44,203,161,0.92);
      border-color: rgba(44,203,161,0.92);
      color:#071018;
      font-weight:990;
      letter-spacing:.3px;
      min-height:46px;
    }
    button.endround{
      background: rgba(255, 181, 72, 0.92);
      border-color: rgba(255, 181, 72, 0.92);
      color:#0b1020;
      font-weight:990;
      letter-spacing:.3px;
      min-height:52px;
    }
    button.export{
      background: rgba(255,255,255,0.92);
      border-color: rgba(255,255,255,0.92);
      color:#0b1020;
      font-weight:980;
      min-height:46px;
    }

    .small{ font-size:12px; opacity:.78; line-height:1.35; position:relative; }

    .log{
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }
    .loglist{
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
    }
    .logitem{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-variant-numeric: tabular-nums;
      font-weight: 850;
      align-items: baseline;
    }
    .logitem .meta{
      opacity: .8;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
      text-transform: uppercase;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Mock Trial Timer</h1>
    <div class="subtitle">True-time clocks. Speech log. iPhone-friendly.</div>
  </div>

  <div class="top-controls">
    <div class="rolebox" title="Choose your side so Speech Start/Pause also controls your side total">
      <div class="title">Your side (sync Speech with)</div>
      <div class="row">
        <label class="roleopt"><input type="radio" name="role" value="pros" id="rolePros"> Prosecution</label>
        <label class="roleopt"><input type="radio" name="role" value="def" id="roleDef"> Defense</label>
      </div>
    </div>

    <button class="resetall" id="resetEverythingBtn" title="Reset all timers and clear speech log">Reset Everything</button>

    <label class="chip" title="Keep screen awake (if supported)">
      <input id="wakeToggle" type="checkbox" />
      Wake Lock
    </label>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Current Speech -->
    <section class="card span-2" aria-label="Current Speech">
      <div class="label">
        <div class="name">Current Speech</div>
        <div class="hint" id="speechHint">Stopped</div>
      </div>
      <div class="time big" id="speechTime">00:00</div>
      <div class="controls">
        <button class="primary" id="speechStart">Start</button>
        <button class="pause" id="speechPause">Pause</button>
        <button class="reset" id="speechReset">Reset</button>
      </div>
      <div class="small">
        Speech Start/Pause syncs to your selected side. Speech lengths log on Speech Reset or End Round.
      </div>
    </section>

    <!-- Prosecution -->
    <section class="card" aria-label="Prosecution Total Time">
      <div class="label">
        <div class="name">Prosecution Total Time</div>
        <div class="hint" id="prosHint">Stopped</div>
      </div>
      <div class="time med" id="prosTime">00:00</div>
      <div class="controls">
        <button class="primary" id="prosStart">Start</button>
        <button class="pause" id="prosPause">Pause</button>
        <button class="reset" id="prosReset">Reset</button>
      </div>
    </section>

    <!-- Defense -->
    <section class="card" aria-label="Defense Total Time">
      <div class="label">
        <div class="name">Defense Total Time</div>
        <div class="hint" id="defHint">Stopped</div>
      </div>
      <div class="time med" id="defTime">00:00</div>
      <div class="controls">
        <button class="primary" id="defStart">Start</button>
        <button class="pause" id="defPause">Pause</button>
        <button class="reset" id="defReset">Reset</button>
      </div>
    </section>

    <!-- Objections Mode -->
    <section class="dock span-2" aria-label="Objections Mode">
      <div class="dock-top">
        <div>
          <div class="dock-title">Objections Mode</div>
          <div class="dock-sub">Pauses current set. Resumes only that set. Round time unaffected.</div>
        </div>
        <div class="dock-sub" id="runningIndicator">All stopped</div>
      </div>

      <div class="dock-buttons">
        <button class="objection" id="objectionPause">Pause current speeches</button>
        <button class="resume" id="objectionResume">Resume current speeches</button>
      </div>
    </section>

    <!-- Total Round Time (BOTTOM) + End Round moved here -->
    <section class="card span-2" aria-label="Total Round Time">
      <div class="label">
        <div class="name">Total Round Time</div>
        <div class="hint" id="roundHint">Stopped</div>
      </div>
      <div class="time med" id="roundTime">00:00</div>
      <div class="controls">
        <button class="primary" id="roundStart">Start</button>
        <button class="pause" id="roundPause">Pause</button>
        <button class="reset" id="roundReset">Reset</button>
      </div>

      <div class="controls" style="margin-top:10px; grid-template-columns: 1fr;">
        <button class="endround" id="endRoundBtn">End Round (save speech log)</button>
      </div>

      <div class="log" aria-label="Speech Log">
        <div class="label" style="margin-top:6px;">
          <div class="name">Speech Log</div>
          <div class="hint" id="logHint">No speeches saved yet</div>
        </div>

        <div class="controls" style="grid-template-columns: 1fr auto;">
          <button class="export" id="exportLogBtn">Export Log</button>
          <button class="reset" id="clearLogBtn">Clear Log</button>
        </div>

        <ul class="loglist" id="logList"></ul>
        <div class="small">Export copies a plain-text log to your clipboard.</div>
      </div>
    </section>

  </div>
</div>

<script>
  function formatMsToMMSS(ms) {
    ms = Math.max(0, ms);
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
  }
  function nowMs() { return Date.now(); }

 class Stopwatch {
  constructor(key) {
    this.key = key;
    this.elapsedMs = 0;
    this.running = false;
    this.startedAtEpoch = 0;

    // Load saved state
    try {
      const raw = localStorage.getItem(this.key);
      if (raw) {
        const data = JSON.parse(raw);
        this.elapsedMs = data.elapsedMs || 0;
        this.running = false; // <-- force NOT running on load
        this.startedAtEpoch = 0;
      }
    } catch {}
  }

  getElapsedMs() {
    if (!this.running) return this.elapsedMs;
    return this.elapsedMs + (Date.now() - this.startedAtEpoch);
  }

  start() {
    if (this.running) return;
    this.running = true;
    this.startedAtEpoch = Date.now();
    this._save();
  }

  stop() {
    if (!this.running) return;
    this.elapsedMs = this.getElapsedMs();
    this.running = false;
    this.startedAtEpoch = 0;
    this._save();
  }

  reset() {
    this.elapsedMs = 0;
    this.running = false;
    this.startedAtEpoch = 0;
    this._save();
  }

  _save() {
    localStorage.setItem(this.key, JSON.stringify({
      elapsedMs: this.elapsedMs
    }));
  }
}
    _load() {
      try {
        const raw = localStorage.getItem(this.key);
        if (!raw) return;
        const data = JSON.parse(raw);
        this.elapsedMs = data.elapsedMs || 0;
        this.running = !!data.running;
        this.startedAtEpoch = data.startedAtEpoch || 0;
      } catch {}
    }
  }

  const speech = new Stopwatch('mt_speech');
  const pros   = new Stopwatch('mt_pros');
  const def    = new Stopwatch('mt_def');
  const round  = new Stopwatch('mt_round');

  const rolePros = document.getElementById('rolePros');
  const roleDef  = document.getElementById('roleDef');
  function getRole() {
    const saved = localStorage.getItem('mt_role');
    if (saved === 'pros' || saved === 'def') return saved;
    return null;
  }
  function setRole(r) {
    localStorage.setItem('mt_role', r);
    rolePros.checked = r === 'pros';
    roleDef.checked  = r === 'def';
  }
  const initialRole = getRole();
  if (initialRole) setRole(initialRole);
  rolePros.addEventListener('change', () => { if (rolePros.checked) setRole('pros'); });
  roleDef.addEventListener('change', () => { if (roleDef.checked) setRole('def'); });

  function loadSpeechLog() {
    try { return JSON.parse(localStorage.getItem('mt_speech_log') || '[]'); }
    catch { return []; }
  }
  function saveSpeechLog(log) {
    localStorage.setItem('mt_speech_log', JSON.stringify(log));
  }
  let speechLog = loadSpeechLog();

  function maybeLogCurrentSpeech(reason) {
    const ms = speech.getElapsedMs();
    if (ms < 1000) return false;
    const seconds = Math.floor(ms / 1000);
    speechLog.push({
      seconds,
      role: getRole() || 'unselected',
      at: new Date().toISOString(),
      reason
    });
    saveSpeechLog(speechLog);
    return true;
  }

  const speechTimeEl = document.getElementById('speechTime');
  const prosTimeEl   = document.getElementById('prosTime');
  const defTimeEl    = document.getElementById('defTime');
  const roundTimeEl  = document.getElementById('roundTime');

  const speechHint = document.getElementById('speechHint');
  const prosHint   = document.getElementById('prosHint');
  const defHint    = document.getElementById('defHint');
  const roundHint  = document.getElementById('roundHint');
  const runningIndicator = document.getElementById('runningIndicator');

  const logList = document.getElementById('logList');
  const logHint = document.getElementById('logHint');

  function startPros() { if (def.running) def.stop(); pros.start(); }
  function startDef()  { if (pros.running) pros.stop(); def.start(); }

  function render() {
    speechTimeEl.textContent = formatMsToMMSS(speech.getElapsedMs());
    prosTimeEl.textContent   = formatMsToMMSS(pros.getElapsedMs());
    defTimeEl.textContent    = formatMsToMMSS(def.getElapsedMs());
    roundTimeEl.textContent  = formatMsToMMSS(round.getElapsedMs());

    speechHint.textContent = speech.running ? 'Running' : 'Stopped';
    prosHint.textContent   = pros.running   ? 'Running' : 'Stopped';
    defHint.textContent    = def.running    ? 'Running' : 'Stopped';
    roundHint.textContent  = round.running  ? 'Running' : 'Stopped';

    const running = [];
    if (speech.running) running.push('Speech');
    if (pros.running)   running.push('Pros');
    if (def.running)    running.push('Def');
    if (round.running)  running.push('Round');
    runningIndicator.textContent = running.length ? `Running: ${running.join(', ')}` : 'All stopped';
  }
  setInterval(render, 250);
  render();

  function speechStartSynced() {
    speech.start();
    const r = getRole();
    if (r === 'pros') startPros();
    if (r === 'def')  startDef();
  }
  function speechPauseSynced() {
    speech.stop();
    const r = getRole();
    if (r === 'pros') pros.stop();
    if (r === 'def')  def.stop();
  }
  document.getElementById('speechStart').addEventListener('click', speechStartSynced);
  document.getElementById('speechPause').addEventListener('click', speechPauseSynced);
  document.getElementById('speechReset').addEventListener('click', () => {
    maybeLogCurrentSpeech('speech_reset');
    speech.reset();
  });

  document.getElementById('prosStart').addEventListener('click', startPros);
  document.getElementById('prosPause').addEventListener('click', () => pros.stop());
  document.getElementById('prosReset').addEventListener('click', () => pros.reset());

  document.getElementById('defStart').addEventListener('click', startDef);
  document.getElementById('defPause').addEventListener('click', () => def.stop());
  document.getElementById('defReset').addEventListener('click', () => def.reset());

  document.getElementById('roundStart').addEventListener('click', () => round.start());
  document.getElementById('roundPause').addEventListener('click', () => round.stop());
  document.getElementById('roundReset').addEventListener('click', () => round.reset());

  let pausedSet = { speech: false, pros: false, def: false };
  function objectionPause() {
    pausedSet = { speech: speech.running, pros: pros.running, def: def.running };
    speech.stop(); pros.stop(); def.stop();
  }
  function objectionResume() {
    if (pausedSet.speech) speech.start();
    if (pausedSet.pros) startPros();
    if (pausedSet.def) startDef();
    pausedSet = { speech: false, pros: false, def: false };
  }
  document.getElementById('objectionPause').addEventListener('click', objectionPause);
  document.getElementById('objectionResume').addEventListener('click', objectionResume);

  function endRound() {
    maybeLogCurrentSpeech('end_round');
    speech.stop(); pros.stop(); def.stop(); round.stop();
    renderLog();
    render();
  }
  document.getElementById('endRoundBtn').addEventListener('click', endRound);

  function resetEverything() {
    speech.stop(); pros.stop(); def.stop(); round.stop();
    speech.reset(); pros.reset(); def.reset(); round.reset();
    speechLog = [];
    saveSpeechLog(speechLog);
    renderLog();
    render();
  }
  document.getElementById('resetEverythingBtn').addEventListener('click', resetEverything);

  function renderLog() {
    logList.innerHTML = '';
    if (!speechLog.length) {
      logHint.textContent = 'No speeches saved yet';
      return;
    }
    logHint.textContent = `${speechLog.length} speech${speechLog.length === 1 ? '' : 'es'} saved`;

    speechLog.forEach((item, idx) => {
      const li = document.createElement('li');
      li.className = 'logitem';

      const left = document.createElement('div');
      left.innerHTML = `<div class="meta">Speech ${idx+1} • ${item.role}</div>`;

      const right = document.createElement('div');
      right.textContent = formatMsToMMSS(item.seconds * 1000);

      li.appendChild(left);
      li.appendChild(right);
      logList.appendChild(li);
    });
  }

  function buildExportText() {
    const lines = [];
    lines.push('Mock Trial Speech Log');
    lines.push(`Exported: ${new Date().toLocaleString()}`);
    lines.push('');
    if (!speechLog.length) {
      lines.push('(No speeches logged)');
      return lines.join('\n');
    }
    speechLog.forEach((item, i) => {
      lines.push(`${i+1}. ${item.role} — ${formatMsToMMSS(item.seconds*1000)}`);
    });
    lines.push('');
    const totalSpeechSeconds = speechLog.reduce((a,b)=>a+b.seconds,0);
    lines.push(`Total speech time logged: ${formatMsToMMSS(totalSpeechSeconds*1000)}`);
    return lines.join('\n');
  }

  async function exportLog() {
    const text = buildExportText();
    try {
      await navigator.clipboard.writeText(text);
      logHint.textContent = `Copied to clipboard ✓ (${speechLog.length} speeches)`;
    } catch {
      window.prompt('Copy this log:', text);
    }
  }
  document.getElementById('exportLogBtn').addEventListener('click', exportLog);
  document.getElementById('clearLogBtn').addEventListener('click', () => {
    speechLog = [];
    saveSpeechLog(speechLog);
    renderLog();
  });

  renderLog();

  // Wake Lock
  let wakeLock = null;
  async function requestWakeLock() {
    try {
      if (!('wakeLock' in navigator)) return false;
      wakeLock = await navigator.wakeLock.request('screen');
      return true;
    } catch { return false; }
  }
  async function releaseWakeLock() {
    try { if (wakeLock) await wakeLock.release(); } catch {}
    wakeLock = null;
  }
  const wakeToggle = document.getElementById('wakeToggle');
  wakeToggle.addEventListener('change', async () => {
    if (wakeToggle.checked) {
      const ok = await requestWakeLock();
      if (!ok) wakeToggle.checked = false;
    } else {
      await releaseWakeLock();
    }
    localStorage.setItem('mt_wake', JSON.stringify({ enabled: wakeToggle.checked }));
  });
  try {
    const s = JSON.parse(localStorage.getItem('mt_wake') || '{}');
    if (s.enabled) {
      wakeToggle.checked = true;
      requestWakeLock().then(ok => { if (!ok) wakeToggle.checked = false; });
    }
  } catch {}
  document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && wakeToggle.checked) {
      await requestWakeLock();
    }
  });

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    });
  }
</script>
</body>
</html>
